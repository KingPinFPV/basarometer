#!/usr/bin/env node

/**
 * 🏪 Add Shufersal Config to Main Scanner
 * Converts the template-generated config to the format expected by basarometer-scanner.js
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const configPath = path.join(__dirname, 'config', 'meat-sites.json');

async function addShufersalConfig() {
  console.log('🏪 Adding Shufersal config to main scanner...');
  
  try {
    // Read existing config
    const configData = fs.readFileSync(configPath, 'utf8');
    const config = JSON.parse(configData);
    
    // Add/update Shufersal configuration in the expected format
    config.shufersal = {
      "name": "שופרסל",
      "baseUrl": "https://www.shufersal.co.il",
      "meatCategories": [
        "/online/he/A32-%D7%91%D7%A9%D7%A8-%D7%95%D7%93%D7%92%D7%99%D7%9D",
        "/online/he/A30-%D7%91%D7%A9%D7%A8-%D7%91%D7%A7%D7%A8-%D7%95%D7%98%D7%9C%D7%94",
        "/online/he/A31-%D7%A2%D7%95%D7%A3"
      ],
      "selectors": {
        "productContainer": ".miglog-product, .product-item, .product, [data-product]",
        "productName": ".miglog-prod-name, .product-name, h3, .product-title, .name",
        "productPrice": ".miglog-price, .price, .product-price, .miglog-total-price, [class*='price']",
        "productImage": "img.miglog-image, img.product-image, img",
        "nextPage": ".pagination-next, .next, button[aria-label*='הבא'], .load-more",
        "loadMore": ".load-more, .btn-load-more, button:contains('טען עוד'), .more-products"
      },
      "waitSelectors": [
        ".miglog-product",
        ".product-item", 
        ".product",
        "[data-product]",
        ".products-grid"
      ],
      "rateLimit": 3000,
      "cloudflareWait": 8000,
      "status": "active",
      "version": "1.0-scanner-ready",
      "template_source": "shufersal_master_analysis",
      "notes": "Generated by Shufersal Template System - Scanner Ready"
    };
    
    // Save updated config
    fs.writeFileSync(configPath, JSON.stringify(config, null, 2));
    
    console.log('✅ Shufersal config added successfully!');
    console.log('');
    console.log('🚀 Ready to test:');
    console.log('   node basarometer-scanner.js --test --site shufersal --debug');
    console.log('');
    console.log('📊 Expected results:');
    console.log('   - Opens Shufersal website');
    console.log('   - Finds meat products');
    console.log('   - Takes debug screenshots');
    console.log('   - Returns products with confidence scores');
    
  } catch (error) {
    console.error('❌ Failed to add Shufersal config:', error.message);
    throw error;
  }
}

// Run if called directly
if (import.meta.url === `file://${process.argv[1]}`) {
  addShufersalConfig()
    .then(() => process.exit(0))
    .catch(error => {
      console.error('💥 Failed:', error.message);
      process.exit(1);
    });
}

export default addShufersalConfig;